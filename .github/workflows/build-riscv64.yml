name: Build RISC-V64

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      publish:
        description: Publish Docker image
        type: boolean
        required: false

jobs:
  build_riscv64:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.04
      options: --privileged -v /var/run/docker.sock:/var/run/docker.sock
    name: Build RISC-V64 on Ubuntu 25.04
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            git \
            build-essential \
            gcc \
            g++ \
            gcc-riscv64-linux-gnu \
            g++-riscv64-linux-gnu \
            binutils-riscv64-linux-gnu \
            wget \
            curl \
            ca-certificates \
            yq \
            docker.io \
            libicu-dev libicu76

      - name: Install .NET 10
        run: |
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 10.0 --install-dir /usr/share/dotnet
          ln -sf /usr/share/dotnet/dotnet /usr/bin/dotnet
          echo "DOTNET_ROOT=/usr/share/dotnet" >> $GITHUB_ENV
          echo "/usr/share/dotnet" >> $GITHUB_PATH

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update nupkg
        run: ./update_nupkg.sh

      - name: Build modules (riscv64)
        run: ./build.sh modules riscv64

      - name: Build bflat (riscv64)
        run: ./build.sh bflat riscv64

      - name: Set up Docker Buildx
        if: github.event.inputs.publish == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event.inputs.publish == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Publish to Docker Hub
        if: github.event.inputs.publish == 'true'
        run: |
          docker buildx build . \
            -t nethermindeth/bflat-riscv64:latest \
            -t nethermindeth/bflat-riscv64:$GITHUB_SHA \
            --push
